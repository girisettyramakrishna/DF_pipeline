pipeline {
    agent any

    environment {
        R_PATH = '/usr/local/lib64/R/bin/R'  // Full path to R
        SHINYAPPS_DEPLOY_ACCOUNT = 'psmlabs' // Your shinyapps.io account name
        SHINYAPPS_DEPLOY_TOKEN = credentials('SHINYAPPS_TOKEN_ID')  // Jenkins credential ID for token
        SHINYAPPS_DEPLOY_SECRET = credentials('SHINYAPPS_SECRET_ID')  // Jenkins credential ID for secret
        APP_NAME = 'demand_forecasting'
        GIT_REPO_URL = 'https://github.com/girisettyramakrishna/DF_pipeline.git'
    }

    stages {
        stage('Checkout Code') {
            steps {
                git branch: 'master', url: "${GIT_REPO_URL}"
            }
        }

        stage('Install Dependencies') {
            steps {
                script {
                    // Install core dependencies
                    sh "${R_PATH} -e \"install.packages(c('remotes', 'devtools'), repos='https://cloud.r-project.org')\""
                    // Install project-specific dependencies
                    sh "${R_PATH} packages_to_be_installed.R"
                }
            }
        }

        stage('Build App') {
            steps {
                script {
                    // Test launching app without browser to catch runtime issues
                    sh "${R_PATH} -e \"shiny::runApp('app.R', launch.browser=FALSE)\" & sleep 5; pkill -f R || true"
                }
            }
        }

        stage('Test (Optional)') {
            steps {
                script {
                    // Run tests if you have them in a 'tests' folder
                    sh "${R_PATH} -e \"if (!requireNamespace('testthat', quietly = TRUE)) install.packages('testthat', repos='https://cloud.r-project.org'); library(testthat); test_dir('tests')\""
                }
            }
        }

        stage('Deploy to ShinyApps.io') {
            steps {
                script {
                    sh """
                    ${R_PATH} -e "if (!requireNamespace('rsconnect', quietly = TRUE)) install.packages('rsconnect', repos='https://cloud.r-project.org')"
                    ${R_PATH} -e "rsconnect::setAccountInfo(name='${SHINYAPPS_DEPLOY_ACCOUNT}', token='${SHINYAPPS_DEPLOY_TOKEN}', secret='${SHINYAPPS_DEPLOY_SECRET}')"
                    ${R_PATH} -e "rsconnect::deployApp(appDir='.', appFile='app.R', appName='${APP_NAME}')"
                    """
                }
            }
        }
    }

    post {
        success {
            echo ' Shiny app deployed successfully!'
        }
        failure {
            echo ' Deployment failed.'
        }
    }
}

